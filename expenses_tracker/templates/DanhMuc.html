{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Quản lý Chi Tiêu</h2>
    
    <!-- Buttons for Add and Delete -->
    <div class="mb-4">
        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
            <i class="fas fa-plus"></i> Thêm Chi Tiêu
        </button>
        <button type="button" class="btn btn-danger" id="deleteSelectedBtn">
            <i class="fas fa-trash"></i> Xóa Chi Tiêu
        </button>
    </div>
    
    <!-- Expense Table -->
    <div class="table-responsive">
        <form id="deleteForm" action="{{ url_for('delete_expenses') }}" method="POST">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>Thời Gian</th>
                        <th>Loại</th>
                        <th>Danh Mục</th>
                        <th>Số Tiền</th>
                        <th>Mô Tả</th>
                    </tr>
                </thead>
                <tbody>
                    {% if expenses.items %}
                        {% for expense in expenses.items %}
                        <tr>
                            <td><input type="checkbox" name="expense_ids" value="{{ expense.id }}" class="expense-checkbox"></td>
                            <td>{{ expense.date.strftime('%d/%m/%Y') }}</td>
                            <td>{{ expense.category.topic.name }}</td>
                            <td>{{ expense.category.name }}</td>
                            <td>{{ "{:,.2f}".format(expense.amount) }}</td>
                            <td>{{ expense.description or "N/A" }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center">Không có dữ liệu chi tiêu</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </form>
    </div>
    
    <!-- Pagination -->
    {% if expenses.pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if expenses.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('DanhMuc', page=expenses.prev_num) }}">Trước</a>
            </li>
            {% endif %}

            {% for num in expenses.iter_pages(left_edge=2, right_edge=2, left_current=1, right_current=1) %}
                {% if num %}
                    {% if num == expenses.page %}
                        <li class="page-item active"><a class="page-link">{{ num }}</a></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('DanhMuc', page=num) }}">{{ num }}</a></li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><a class="page-link">...</a></li>
                {% endif %}
            {% endfor %}

            {% if expenses.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('DanhMuc', page=expenses.next_num) }}">Tiếp</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-labelledby="addExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addExpenseModalLabel">Thêm Chi Tiêu Mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('add_expense') }}">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        <label class="form-label">Loại:</label>
                        <div class="mb-3">
                            {{ form.topic(class="form-select") }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh Mục:</label>
                        <div>
                            {{ form.category(class="form-select") }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số Tiền:</label>
                        <div>
                            {{ form.amount(class="form-control", placeholder="Nhập số tiền") }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ngày:</label>
                        <div>
                            {{ form.date(class="form-control", type="date") }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô Tả (tùy chọn):</label>
                        <div>
                            {{ form.description(class="form-control", placeholder="Nhập mô tả chi tiêu") }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- JavaScript for handling select all and form submission -->
<script>
    // Select all functionality
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.expense-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
    
    // Delete selected expenses
    document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.expense-checkbox:checked');
        if (checkboxes.length > 0) {
            if (confirm('Bạn có chắc chắn muốn xóa ' + checkboxes.length + ' chi tiêu đã chọn?')) {
                document.getElementById('deleteForm').submit();
            }
        } else {
            alert('Vui lòng chọn ít nhất một chi tiêu để xóa!');
        }
    });
    
    // Dynamically update categories based on selected topic
    document.getElementById('topic').addEventListener('change', function() {
    const topicType = this.value;
    
    fetch('/get_categories/' + topicType)
        .then(response => response.json())
        .then(data => {
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '';

            if (data.categories.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No categories available';
                categorySelect.appendChild(option);
                return;
            }

            data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        });
});

// Ensure categories load when the page loads
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('topic').dispatchEvent(new Event('change'));
});


    
    // Trigger change event to load initial categories
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('topic').dispatchEvent(new Event('change'));
    });
</script>
{% endblock content %}